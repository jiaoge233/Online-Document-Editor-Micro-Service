<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åœ¨çº¿æ–‡æ¡£ç¼–è¾‘å™¨æµ‹è¯•</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: rgba(255, 255, 255, 0.06);
            --panel-strong: rgba(255, 255, 255, 0.10);
            --border: rgba(255, 255, 255, 0.14);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.68);
            --primary: #5b8cff;
            --primary-2: #7c4dff;
            --danger: #ff5b6b;
            --shadow: 0 18px 45px rgba(0, 0, 0, 0.35);
            --radius: 14px;
            --radius-sm: 10px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: var(--sans);
            color: var(--text);
            background:
                radial-gradient(1200px 800px at 20% 10%, rgba(91, 140, 255, 0.35), transparent 55%),
                radial-gradient(900px 700px at 85% 15%, rgba(124, 77, 255, 0.28), transparent 55%),
                radial-gradient(900px 700px at 60% 95%, rgba(0, 255, 209, 0.10), transparent 60%),
                linear-gradient(180deg, #070a12, var(--bg));
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 28px 18px 40px;
        }

        .header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
            margin-bottom: 18px;
        }

        .title {
            margin: 0;
            font-size: 20px;
            letter-spacing: 0.2px;
        }

        .subtitle {
            margin-top: 6px;
            margin-bottom: 0;
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
        }

        .grid {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 14px;
            align-items: start;
        }

        @media (max-width: 960px) {
            .grid { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .cardHeader {
            padding: 14px 14px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.10);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .cardTitle {
            font-size: 13px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.78);
        }

        .cardBody { padding: 14px; }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            appearance: none;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            line-height: 1;
            transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
            user-select: none;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.10);
            border-color: rgba(255, 255, 255, 0.22);
            transform: translateY(-1px);
        }

        .btn:active { transform: translateY(0px); }

        .btnPrimary {
            border: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-2));
            box-shadow: 0 10px 22px rgba(91, 140, 255, 0.18);
        }

        .btnDanger {
            border: 1px solid rgba(255, 91, 107, 0.35);
            background: rgba(255, 91, 107, 0.12);
        }

        .form {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .field {
            display: grid;
            gap: 6px;
        }

        .label {
            font-size: 12px;
            color: var(--muted);
        }

        .input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(0, 0, 0, 0.18);
            color: var(--text);
            outline: none;
            transition: border-color 120ms ease, box-shadow 120ms ease;
        }

        .input:focus {
            border-color: rgba(91, 140, 255, 0.65);
            box-shadow: 0 0 0 4px rgba(91, 140, 255, 0.18);
        }

        .pill {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.20);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.88);
            font-family: var(--mono);
            font-size: 12px;
            line-height: 1.5;
            word-break: break-all;
        }

        #status {
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            min-height: 42px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.86);
        }

        #messages {
            height: 320px;
            overflow: auto;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(0, 0, 0, 0.22);
            padding: 12px;
            font-family: var(--mono);
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        #messages > div {
            padding: 6px 8px;
            border-radius: 10px;
        }

        #messages > div:nth-child(odd) { background: rgba(255, 255, 255, 0.04); }

        .editorWrap {
            display: grid;
            gap: 10px;
        }

        #editor {
            width: 100%;
            height: 340px;
            resize: vertical;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(0, 0, 0, 0.18);
            color: var(--text);
            padding: 12px;
            outline: none;
            font-family: var(--mono);
            font-size: 13px;
            line-height: 1.55;
            transition: border-color 120ms ease, box-shadow 120ms ease;
        }

        #editor:focus {
            border-color: rgba(124, 77, 255, 0.65);
            box-shadow: 0 0 0 4px rgba(124, 77, 255, 0.18);
        }

        #caretInfo {
            font-size: 12px;
            color: var(--muted);
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.10);
        }

        .helper {
            margin: 0;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.55;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div>
                <h2 class="title">åœ¨çº¿æ–‡æ¡£ç¼–è¾‘å™¨æµ‹è¯•</h2>
                <p class="subtitle">
                    è¿™æ˜¯ä¸€ä¸ªæœ€å°å®è·µæµ‹è¯•é¡µï¼šç™»å½•/åˆ·æ–° Tokenã€WebSocket è¿æ¥ã€åˆ›å»º/åŠ å…¥æ–‡æ¡£ã€åŠ è½½å†…å®¹ã€æäº¤æ“ä½œä¸ Delta æ¨é€ã€‚
                </p>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="cardHeader">
                    <div class="cardTitle">æ§åˆ¶å°</div>
                </div>
                <div class="cardBody">
                    <div class="toolbar">
                        <button class="btn btnPrimary" onclick="connectWS()">è¿æ¥ WebSocket</button>
                        <button class="btn" onclick="RefreshToken()">åˆ·æ–° token</button>
                        <button class="btn" onclick="createDocument()">åˆ›å»ºæ–‡æ¡£</button>
                        <button class="btn" onclick="joinDocument()">åŠ å…¥æ–‡æ¡£</button>
                        <button class="btn" onclick="show_alive_members()">æŸ¥è¯¢ hub åœ¨çº¿æˆå‘˜</button>
                        <button class="btn" onclick="loadDocumentContent()">æ¢å¤æ–‡æ¡£å†…å®¹åˆ°å‰ç«¯</button>
                        <button class="btn btnDanger" onclick="op_submit()">æäº¤æ“ä½œ</button>
                    </div>

                    <div class="form">
                        <div class="field">
                            <div class="label">ç”¨æˆ·å</div>
                            <input class="input" type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
                        </div>
                        <div class="field">
                            <div class="label">å¯†ç </div>
                            <input class="input" type="text" id="password" placeholder="è¯·è¾“å…¥å¯†ç " />
                        </div>
                        <div class="field">
                            <div class="label">æ–‡æ¡£æ ‡é¢˜</div>
                            <input class="input" type="text" id="docTitle" placeholder="è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜" />
                        </div>
                        <div class="field">
                            <div class="label">å½“å‰ docIdï¼ˆWS è¿”å›ï¼‰</div>
                            <div class="pill" id="docIdDisplay">ï¼ˆæš‚æ— ï¼‰</div>
                        </div>

                        <div class="toolbar">
                            <button class="btn btnPrimary" onclick="login()">ç™»å½•</button>
                            <button class="btn" onclick="register()">æ³¨å†Œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="cardHeader">
                    <div class="cardTitle">ç¼–è¾‘åŒº</div>
                </div>
                <div class="cardBody">
                    <div class="editorWrap">
                        <p class="helper">æç¤ºï¼šæ­¤å¤„ä¸ºâ€œå…¨é‡æ›¿æ¢ Deltaâ€æœ€å°å®ç°ï¼›è¾“å…¥å†…å®¹ä¼šè§¦å‘ `op_submit` ç±»å‹æ¶ˆæ¯å‘é€ã€‚</p>
                        <textarea id="editor"></textarea>
                        <div id="caretInfo">å…‰æ ‡ä½ç½®: 0, é€‰åŒºé•¿åº¦: 0</div>
                    </div>
                </div>
            </div>
        </div>

        <div style="height: 14px;"></div>

        <div class="card">
            <div class="cardHeader">
                <div class="cardTitle">è¿æ¥çŠ¶æ€</div>
            </div>
            <div class="cardBody">
                <div id="status"></div>
            </div>
        </div>

        <div style="height: 14px;"></div>

        <div class="card">
            <div class="cardHeader">
                <div class="cardTitle">æ¶ˆæ¯æ—¥å¿—</div>
            </div>
            <div class="cardBody">
                <div id="messages"></div>
            </div>
        </div>

    <script>
        let ws = null;
        
        function log(...args) {
            const logElement = document.getElementById('messages');
            if (!logElement) {
                console.error('Log element not found!');
                console.log(...args);
                return;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            
            // æ·»åŠ æ—¶é—´æˆ³
            const timeSpan = document.createElement('span');
            timeSpan.textContent = `[${timestamp}] `;
            entry.appendChild(timeSpan);
            
            // å¤„ç†æ¯ä¸ªå‚æ•°
            args.forEach(arg => {
                const argSpan = document.createElement('span');
                
                if (typeof arg === 'object') {
                    // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸ºç»¿è‰²å­—ç¬¦ä¸²
                    argSpan.textContent = JSON.stringify(arg, null, 2);
                    argSpan.style.color = 'blue';
                } else {
                    // å…¶ä»–å‚æ•°ä¿æŒåŸæ ·
                    argSpan.textContent = arg;
                }
                
                // æ·»åŠ ç©ºæ ¼åˆ†éš”
                argSpan.textContent += ' ';
                entry.appendChild(argSpan);
            });
            
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(status, color) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = status;
            statusDiv.style.backgroundColor = color;
        }

        function register() {
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            
            fetch('http://localhost:3000/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                log('Register response:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function login() {
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            fetch('http://localhost:3000/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                log('Login response:', data);

                if (data.accessToken) {
                localStorage.setItem('accessToken', data.accessToken);
                localStorage.setItem('username', username);
                if (data.refreshToken) {
                    localStorage.setItem('refreshToken', data.refreshToken);
                }
                localStorage.setItem('expiresIn', data.expiresIn);
                log('Tokens stored in localStorage');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function RefreshToken() {
            fetch('http://localhost:3000/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    refreshToken: localStorage.getItem('refreshToken')
                })
            })
            .then(response => response.json())
            .then(data => {
                log('Refresh token response:', data);
                if (data.accessToken) {
                    localStorage.setItem('accessToken', data.accessToken);
                    if (data.refreshToken) {
                        localStorage.setItem('refreshToken', data.refreshToken);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function joinDocument() {
            const docTitle = document.getElementById('docTitle').value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'joinDocument',
                    docTitle: docTitle,
                    username: localStorage.getItem('username')
                });
                ws.send(message);
                document.getElementById('editor').value = "";
            }
        }

        function createDocument() {
            const docTitle = document.getElementById('docTitle').value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'createDocument',
                    docTitle: docTitle,
                    username: localStorage.getItem('username')
                });
                ws.send(message);
            }
        }
        
        function connectWS() {
            const token = localStorage.getItem('accessToken');
            const url = `ws://localhost:3000/ws?lastKnownRevision=0&token=${encodeURIComponent(token)}`;
            
            log(`å°è¯•è¿æ¥åˆ°: ${url}`);
            updateStatus('è¿æ¥ä¸­...', 'yellow');
            
            ws = new WebSocket(url);
            console.log("ws.url(real) =", ws.url);
            
            ws.onopen = function(event) {
                log('âœ… WebSocket è¿æ¥æˆåŠŸå»ºç«‹');
                updateStatus('è¿æ¥æˆåŠŸ', 'lightgreen');
                log('è¿æ¥å¯¹è±¡: ' + JSON.stringify({
                    url: event.target.url,
                    protocol: event.target.protocol,
                    readyState: event.target.readyState
                }));
            };
            
            ws.onmessage = function(event) {
                log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + event.data);
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'op_applied':
                        if (data.docId == localStorage.getItem('docId')) {
                            baseRevision = data.currentRevision;
                        }
                        break;
                    case 'loadDocumentContent':
                        editor.value = data.content || "";
                        lastText = editor.value;      // åŒæ­¥æœ¬åœ°ç¼“å­˜ï¼Œé¿å…ä¸‹ä¸€æ¬¡ delete é•¿åº¦ä¸å¯¹
                        updateCaretInfo();
                        baseRevision = data.revision;
                        log('è®¾ç½® baseRevision =', baseRevision)
                        document.getElementById('editor').value = data.content;
                        break;

                    case 'joinDocument':
                        localStorage.setItem('docId', data.docId);
                        updateDocIdDisplay();
                        break;

                    case 'createDocument':
                        localStorage.setItem('docId', data.docId);
                        updateDocIdDisplay();
                        break;

                    case 'error':
                        log('âŒ é”™è¯¯: ' + data.content);
                        break;
                }
            };
            
            ws.onerror = function(error) {
                log('âŒ WebSocket é”™è¯¯: ' + JSON.stringify(error));
                updateStatus('è¿æ¥é”™è¯¯', 'lightcoral');
                console.error('WebSocket é”™è¯¯è¯¦æƒ…:', error);
            };
            
            ws.onclose = function(event) {
                log('ğŸ”Œ WebSocket è¿æ¥å…³é—­: code=' + event.code + ', reason=' + JSON.stringify(event.reason));
                updateStatus('è¿æ¥å·²å…³é—­', 'lightgray');
            };
        }

        // ==== æ–‡æ¡£ç¼–è¾‘æœ€å°å®è·µ ====

        // æœ¬åœ°ç¼“å­˜çš„æ–‡æ¡£å†…å®¹ï¼Œç”¨äºæ„é€  Deltaï¼ˆæœ€å°ç‰ˆï¼šå…¨é‡æ›¿æ¢ï¼‰
        let lastText = "";
        // å®¢æˆ·ç«¯æ ‡è¯† & åºå·ï¼Œç”¨äºå’Œåç«¯çš„å¹‚ç­‰é€»è¾‘å¯¹ä¸Š
        let clientId = "tab-" + Math.random().toString(36).slice(2);
        let clientSeq = 1;
        // å½“å‰å·²çŸ¥ç‰ˆæœ¬ï¼ˆæœ€å°å®è·µå…ˆä» 0 å¼€å§‹ï¼Œåé¢å¯ä»¥åœ¨æ”¶åˆ° op_applied æ—¶å†æ›´æ–°ï¼‰
        let baseRevision = 0;

        const editor = document.getElementById('editor');
        const caretInfo = document.getElementById('caretInfo');
        const docIdDisplay = document.getElementById('docIdDisplay');

        function updateDocIdDisplay() {
            if (!docIdDisplay) return;
            const docId = localStorage.getItem('docId');
            docIdDisplay.textContent = docId ? docId : "ï¼ˆæš‚æ— ï¼‰";
        }

        // æ›´æ–°å…‰æ ‡ä¿¡æ¯æ˜¾ç¤º
        function updateCaretInfo() {
            if (!editor || !caretInfo) return;
            const index = editor.selectionStart;
            const length = editor.selectionEnd - editor.selectionStart;
            caretInfo.textContent = `å…‰æ ‡ä½ç½®: ${index}, é€‰åŒºé•¿åº¦: ${length}`;
        }

        // ç›‘å¬å…‰æ ‡ç§»åŠ¨ï¼šç‚¹å‡» / é”®ç›˜
        editor.addEventListener('click', updateCaretInfo);
        editor.addEventListener('keyup', updateCaretInfo);

        // ç›‘å¬å†…å®¹å˜åŒ–ï¼šæœ€å°å®è·µ â†’ å½“å†…å®¹å˜åŒ–å°±å‘ä¸€æ¬¡â€œå…¨é‡æ›¿æ¢â€çš„ Delta
        editor.addEventListener('input', onEditorInput);

        // åˆå§‹åŒ–æ˜¾ç¤ºï¼ˆä¸å½±å“ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼‰
        updateDocIdDisplay();

        function onEditorInput() {
        const newText = editor.value;
        const oldText = lastText;

        // æ„é€ ä¸€ä¸ªâ€œæŠŠæ—§å†…å®¹å…¨éƒ¨åˆ æ‰ï¼Œå†æ’å…¥æ–°å†…å®¹â€çš„ Delta
        sendFullReplaceDelta(oldText, newText);

        lastText = newText;
        updateCaretInfo();
        }

        // æœ€å°å®è·µï¼šå…¨é‡æ›¿æ¢ Delta
        function sendFullReplaceDelta(oldText, newText) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œæš‚ä¸å‘é€ Delta');
            return;
        }

        const ops = [];
        if (oldText.length > 0) {
            ops.push({ kind: "delete", count: oldText.length });
        }
        if (newText.length > 0) {
            ops.push({ kind: "insert", text: newText });
        }
        if (ops.length === 0) {
            return; // ç©ºæ“ä½œä¸å‘
        }

        const msg = {
            type: "op_submit",
            docId: localStorage.getItem('docId') || "1",
            baseRevision: baseRevision,
            clientId: clientId,
            clientSeq: clientSeq++,
            ops: ops,
        };

        const json = JSON.stringify(msg);
        ws.send(json);
        log('ğŸ“¤ å‘é€ Delta: ' + json);
        }

        function loadDocumentContent() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'loadDocumentContent',
                    docId: localStorage.getItem('docId')
                })
                ws.send(message);
                log('ğŸ“¤ å‘é€æ¶ˆæ¯: ' + message);
            } else {
                log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
            }
        }

        function show_alive_members() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'show_alive_members',
                    docId: localStorage.getItem('docId')
                });
                ws.send(message);
            }
        }

        function op_submit() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({
                    type: 'saveDocument',
                    docId: localStorage.getItem('docId'),
                    baseRevision: baseRevision,
                    clientId: '1',
                    clientSeq: 1,
                    
                });
            ws.send(message);
            log('ğŸ“¤ å‘é€æ¶ˆæ¯: ' + message);
        } else {
                log('âš ï¸ WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
            }
        }

    </script>
</div>
</body>
</html>